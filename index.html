<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rocket Crash - Stars Edition</title>
    <style>
        :root { --bg: #0b0e11; --surface: #1e2329; --primary: #02d1a4; --danger: #f6465d; --accent: #f0b90b; --text: #eaecef; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: -apple-system, system-ui, sans-serif; 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .history-bar { 
            height: 40px; background: #181a20; display: flex; align-items: center; gap: 8px; 
            padding: 0 10px; overflow-x: auto; flex-shrink: 0; border-bottom: 1px solid #2b3139;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .history-bar::-webkit-scrollbar { display: none; }
        .hist-chip { padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; background: #2b3139; flex-shrink: 0; }

        .balance-float { 
            position: absolute; top: 12px; right: 12px; font-weight: bold; color: var(--accent); 
            z-index: 10; background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 20px; 
            border: 1px solid #333; font-size: 14px; 
        }
        
        .game-view { flex-grow: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #multi { font-size: 85px; font-weight: 900; z-index: 2; margin: 0; text-shadow: 0 0 25px rgba(0,0,0,0.9); }
        canvas { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 1; opacity: 0.5; }

        .controls { background: var(--surface); padding: 15px; border-top: 1px solid #2b3139; display: flex; flex-direction: column; gap: 12px; z-index: 5; }
        .inputs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
        .input-wrapper { display: flex; flex-direction: column; gap: 6px; }
        .label-row { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #848e9c; font-weight: bold; text-transform: uppercase; height: 16px; }
        .input-field { background: var(--bg); border: 1px solid #474d57; border-radius: 8px; display: flex; align-items: center; padding: 0 12px; height: 50px; }
        .input-field input { background: none; border: none; color: white; font-size: 18px; width: 100%; font-weight: bold; }
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); margin: 0; }
        .x2-btn { color: var(--primary); font-weight: bold; font-size: 14px; background: none; border: none; padding-left: 10px; cursor: pointer; }

        .btn-main { width: 100%; height: 60px; border-radius: 10px; border: none; font-weight: 900; font-size: 22px; cursor: pointer; text-transform: uppercase; }
        .state-bet { background: var(--primary); color: #000; box-shadow: 0 4px 0 #01a380; }
        .state-cash { background: var(--accent); color: #000; box-shadow: 0 4px 0 #c79a08; }
        .state-wait { background: #474d57; color: #848e9c; }

        .players-section { height: 30%; background: #14171a; overflow-y: auto; border-top: 1px solid #2b3139; }
        .player-row { display: grid; grid-template-columns: 1.2fr 0.8fr 1fr; padding: 12px 15px; font-size: 13px; border-bottom: 1px solid #1e2329; }
        .win { color: var(--primary); font-weight: bold; }
        .loss { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

    <div class="balance-float">⭐ <span id="balance">100</span></div>
    <div id="history" class="history-bar"></div>
    
    <div class="game-view">
        <h1 id="multi">x1.00</h1>
        <canvas id="chart"></canvas>
    </div>

    <div class="controls">
        <div class="inputs-grid">
            <div class="input-wrapper">
                <div class="label-row">СУММА</div>
                <div class="input-field">
                    <input type="number" id="betAmount" value="10">
                    <button class="x2-btn" onclick="document.getElementById('betAmount').value *= 2">X2</button>
                </div>
            </div>
            <div class="input-wrapper">
                <div class="label-row">
                    <input type="checkbox" id="autoEnabled" checked>
                    <span>АВТО-ВЫВОД</span>
                </div>
                <div class="input-field">
                    <input type="number" id="autoCash" value="2.0" step="0.1">
                </div>
            </div>
        </div>
        <button id="mainBtn" class="btn-main state-bet" onclick="handleAction()">Ставка</button>
    </div>

    <div class="players-section" id="bet-list"></div>

<script>
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    const multiTxt = document.getElementById('multi');
    const mainBtn = document.getElementById('mainBtn');
    const balanceTxt = document.getElementById('balance');
    const betList = document.getElementById('bet-list');
    const autoCheck = document.getElementById('autoEnabled');
    const historyBar = document.getElementById('history');

    canvas.width = window.innerWidth * 2;
    canvas.height = window.innerHeight;

    let balance = 100; // НОВЫЙ БАЛАНС
    let isPlaying = false;
    let hasCashed = false;
    let gameStatus = 'wait'; 
    let currentX = 1.00;
    let lastX = 2.0; // Храним результат прошлого раунда
    let bots = [];
    const myBots = ["Kevnz", "Delloris", "danzler", "lordum", "exzmen", "introspect", "lanlk"];

    function handleAction() {
        if (gameStatus === 'wait' && !isPlaying) {
            let b = parseFloat(document.getElementById('betAmount').value);
            if (b > balance || b <= 0) return;
            balance -= b;
            isPlaying = true;
            balanceTxt.innerText = Math.floor(balance);
            mainBtn.innerText = "ПРИНЯТО";
            mainBtn.className = "btn-main state-wait";
        } else if (gameStatus === 'run' && isPlaying && !hasCashed) {
            cashOut();
        }
    }

    function cashOut() {
        if (hasCashed) return;
        let bet = parseFloat(document.getElementById('betAmount').value);
        let win = Math.floor(bet * currentX);
        balance += win;
        balanceTxt.innerText = Math.floor(balance);
        hasCashed = true;
        mainBtn.innerText = `УСПЕЛ! (${win})`;
        mainBtn.className = "btn-main state-wait";
    }

    function createBots() {
        betList.innerHTML = "";
        bots = [];
        myBots.forEach(name => {
            if (Math.random() > 0.4) {
                bots.push({
                    name: name,
                    bet: Math.floor(Math.random() * 50 + 5),
                    outAt: (1.2 + Math.random() * 10).toFixed(2),
                    done: false
                });
            }
        });
        bots.forEach((b, i) => {
            betList.innerHTML += `<div class="player-row"><span>${b.name}</span><span>${b.bet}</span><span id="bot-r-${i}">...</span></div>`;
        });
    }

    async function gameLoop() {
        while(true) {
            gameStatus = 'wait';
            createBots();
            multiTxt.innerText = "x1.00"; 
            multiTxt.style.color = "#fff";
            
            for(let i=5; i>0; i--) {
                if (!isPlaying) { 
                    mainBtn.innerText = `СТАВКА (${i}с)`; 
                    mainBtn.className = "btn-main state-bet"; 
                } else { 
                    mainBtn.innerText = `ОЖИДАНИЕ ${i}с`; 
                }
                await new Promise(r => setTimeout(r, 1000));
            }

            gameStatus = 'run';
            hasCashed = false;

            // --- УМНАЯ ЛОГИКА СЛИВОВ И ВЫДАЧИ ---
            let crashAt;
            let r = Math.random();

            if (lastX < 1.8) { 
                // Если прошлый раз был слив — шанс на "ракету" выше (60% летим высоко)
                if (r < 0.6) crashAt = 5 + Math.random() * 125;
                else crashAt = 1.2 + Math.random() * 3;
            } else if (lastX > 15) {
                // Если прошлый раз была жирная выдача — 70% шанс на слив
                if (r < 0.7) crashAt = 1.05 + Math.random() * 0.5;
                else crashAt = 2 + Math.random() * 5;
            } else {
                // Обычный режим
                if (r < 0.1) crashAt = 1.01 + Math.random() * 0.1;
                else if (r < 0.4) crashAt = 3 + Math.random() * 40;
                else crashAt = 1.2 + Math.random() * 2.5;
            }

            crashAt = Math.min(crashAt, 130).toFixed(2);
            
            if (isPlaying) { mainBtn.innerText = "ЗАБРАТЬ"; mainBtn.className = "btn-main state-cash"; }
            
            let start = Date.now();
            await new Promise(resolve => {
                let itv = setInterval(() => {
                    let elapsed = (Date.now() - start) / 1000;
                    currentX = Math.pow(1.18, elapsed * 1.6);

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.beginPath(); ctx.strokeStyle = "#02d1a4"; ctx.lineWidth = 12;
                    ctx.moveTo(0, canvas.height * 0.85);
                    let scaleX = currentX > 50 ? 60 : 115;
                    for(let t=0; t<=elapsed; t+=0.1) {
                        ctx.lineTo(t*scaleX, (canvas.height * 0.85) - (Math.pow(1.18, t * 1.6) * 30));
                    }
                    ctx.stroke();

                    multiTxt.innerText = "x" + currentX.toFixed(2);
                    if (currentX >= 100) multiTxt.style.color = "var(--accent)";

                    if (isPlaying && !hasCashed && autoCheck.checked) {
                        if (currentX >= parseFloat(document.getElementById('autoCash').value) && currentX < crashAt) cashOut();
                    }

                    bots.forEach((b, idx) => {
                        if (!b.done && currentX >= b.outAt && b.outAt < crashAt) {
                            b.done = true;
                            document.getElementById(`bot-r-${idx}`).innerHTML = `<span class="win">${Math.floor(b.bet * b.outAt)}</span>`;
                        }
                    });

                    if (currentX >= crashAt) {
                        clearInterval(itv);
                        doCrash(currentX);
                        resolve();
                    }
                }, 50);
            });
            await new Promise(r => setTimeout(r, 4000));
        }
    }

    function doCrash(x) {
        gameStatus = 'crash';
        lastX = parseFloat(x); // Запоминаем для следующего раунда
        multiTxt.innerText = "CRASH!"; multiTxt.style.color = "var(--danger)";
        isPlaying = false;
        bots.forEach((b, idx) => {
            if (!b.done) document.getElementById(`bot-r-${idx}`).innerHTML = `<span class="loss">${Math.floor(b.bet * x)}</span>`;
        });
        let h = document.createElement('div');
        h.className = 'hist-chip';
        h.style.color = x >= 100 ? '#ff00ea' : (x >= 10 ? 'var(--accent)' : (x >= 2 ? 'var(--primary)' : 'var(--danger)'));
        h.innerText = 'x' + lastX.toFixed(2);
        historyBar.prepend(h);
    }

    gameLoop();
</script>
</body>
</html>
